<!DOCTYPE html>
<html lang="en">
<head>
    <title>multi panel test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../jquery-ui/ui-lightness/jquery-ui-1.9.1.custom.min.css" />
    <script src="../jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="../jquery-ui/jquery-ui-1.9.1.custom.min.js" type="text/javascript"></script>
    <script type="text/javascript">
    /**
     * Function call throttling
     */
    var throttle = (function() {
        return function(fn, timeout) {
            var timer, args, invoke, tick;
            timeout = timeout || 4;
            tick = function () {
                if (invoke) {
                    fn.apply({}, args);
                    invoke = 0;
                    timer = setTimeout(tick, timeout);
                } else {
                    timer = 0;
                }
            };
            return function() {
                args = arguments;
                invoke = 1;
                if (! timer) {
                    tick();
                }
            };
        };
    })();


    function getEventPosition(self, e, $obj) {
        var x = 0, y = 0;
        var oe = e.originalEvent;
        var touch = oe.touches || oe.changedTouches;
        var offset;
        var previewHeight;
        if (self) {
            offset = $obj.parent().offset();
            previewHeight = self._preview.outerHeight();
        } else {
            offset = $obj.offset();
            previewHeight = 0;
        }
        if (touch) {
            // touchscreen
            x = touch[0].pageX - offset.left;
            y = touch[0].pageY - offset.top - previewHeight;
        } else if (e.pageX) {
            // mouse
            x = e.pageX - offset.left;
            y = e.pageY - offset.top - previewHeight;
        }
        return [x, y];
    }

    /**
     * COLOR MANAGEMENT
     */
    var Color = (function () {
        function Color(value) {
            var self = this;
            // default to black
            self.rgb  = { r:0, g:0, b:0 };
            self.hsl  = { h:0, s:0, l:0 };
            self.cmyk = { c:0, m:0, y:0, k:1 };
            self.hex  = "#000000";
            self.setColor(value);
        }
        // setters
        Color.prototype.setColor = function(value) {
            var self = this;
            if (typeof value == 'object' && value) {
                var haveFields = function (value, fields) {
                    for (var i in fields.split('')) {
                        if (typeof value[fields[i]] != 'number'
                            || isNaN(value[fields[i]])
                            || value[fields[i]] < 0
                            || value[fields[i]] > 1
                        ) {
                            return 0;
                        }
                    }
                    return 1;
                };
                if (haveFields(value, 'sl')
                    && typeof value.h == 'number'
                    && ! isNaN(value.h)
                ) {
                    value.h = value.h - Math.floor(value.h);
                    if (value.h < 0) {
                        value.h = 1 + value.h;
                    }
                    setHsl(self, value);
                } else if (haveFields(value, 'rgb')) {
                    setRgb(self, value);
                } else if (haveFields(value, 'cmyk')) {
                    setCmyk(self, value);
                } else {
                    self.setColor(value.hsl)
                        .setColor(value.rgb)
                        .setColor(value.cmyk);
                }
            } else if (typeof value == 'string') {
                setHex(self, value);
            }
            return self;
        };
        Color.prototype.getTextColor = function() {
            var rgb = this.rgb;
            // See BT 709 color spec
            var luma = rgb.r*0.2126 + rgb.g*0.7152 + rgb.b*0.0722;
            return new Color(luma < 0.35 ? '#fff' : '#000');
        };
        function setRgb(self, value) {
            self.rgb = value;
            self.hsl = rgb2hsl(value);
            self.cmyk = rgb2cmyk(value);
            self.hex = rgb2hex(value);
        }
        function setHsl(self, value) {
            self.hsl = value;
            self.rgb = hsl2rgb(value);
            self.cmyk = rgb2cmyk(self.rgb);
            self.hex = rgb2hex(self.rgb);
        }
        function setHex(self, value) {
            if (/^#([0-9a-f]{3}){1,2}$/i.test(value)) {
                if (value.length === 4) {
                    value = value.replace(/[0-9a-f]/gi, function(match) {
                        return match + match;
                    });
                }
                self.hex = value;
                self.rgb = hex2rgb(value);
                self.cmyk = rgb2cmyk(self.rgb);
                self.hsl = rgb2hsl(self.rgb);
            }
        }
        function setCmyk(self, value) {
            self.cmyk = value;
            self.rgb = cmyk2rgb(value);
            self.hsl = rgb2hsl(self.rgb);
            self.hex = rgb2hex(self.rgb);
        }
        // converters
        function rgb2hsl(value) {
            var r = value.r,
            g = value.g,
            b = value.b,
            max = Math.max(r, g, b),
            min = Math.min(r, g, b),
            h,
            s,
            l = (max + min) / 2;
            if (max === min) {
                h = s = 0; // achromatic
            } else {
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return {
                h: h,
                s: s,
                l: l
            };
        }
        function rgb2hex(input) {
            var value, byte, retval = '', i=0;
            for (;i<3;i++) {
                byte = Math.round(input[['r','g','b'][i]] * 255);
                value = byte.toString(16);
                if (byte < 16) {
                    value = "0" + value;
                }
                retval += value;
            }
            return '#' + retval;

        }
        function hex2rgb(value) {
            var i=0, retval = {};
            for (;i<3;i++) {
                retval[i] = parseInt('0x' + value.substring(i*2+1,i*2+3), 16) / 255;
            }
            return {
                r: retval[0],
                g: retval[1],
                b: retval[2]
            };
        }
        function hsl2rgb(value) {
            var r, g, b;
            if (value.s === 0) {
                r = g = b = value.l; // achromatic
            } else {
                var hue2rgb = function (p, q, t) {
                    if (t < 0) {
                        t += 1;
                    } else if (t > 1) {
                        t -= 1;
                    }
                    if (t < 1/6) {
                        return p + (q - p) * 6 * t;
                    }
                    if (t < 1/2) {
                        return q;
                    }
                    if (t < 2/3) {
                        return p + (q - p) * (2/3 - t) * 6;
                    }
                    return p;
                };

                var q;
                if (value.l < 0.5) {
                    q = value.l * (1 + value.s);
                } else {
                    q = value.l + value.s - value.l * value.s;
                }
                var p = 2 * value.l - q;
                r = hue2rgb(p, q, value.h + 1/3);
                g = hue2rgb(p, q, value.h);
                b = hue2rgb(p, q, value.h - 1/3);
            }
            return {
                r: r,
                g: g,
                b: b
            };
        }
        function rgb2cmyk(value) {
            // achromatic
            if (value.r === value.g && value.g === value.b) {
                return {
                    c:0,
                    m:0,
                    y:0,
                    k:1 - value.r
                };
            }
            var k = Math.min(
                1 - value.r,
                1 - value.g,
                1 - value.b
            );
            return {
                c:(1 - value.r - k) / (1 - k),
                m:(1 - value.g - k) / (1 - k),
                y:(1 - value.b - k) / (1 - k),
                k:k
            };
        }
        function cmyk2rgb(value) {
            return {
                r: 1 - Math.min(1, value.c * (1 - value.k) + value.k),
                g: 1 - Math.min(1, value.m * (1 - value.k) + value.k),
                b: 1 - Math.min(1, value.y * (1 - value.k) + value.k)
            };
        }
        return Color;
    })();
    </script>


    <script src="panel.js" type="text/javascript"></script>
    <script type="text/javascript">
    $(document).ready(function () {
        panel = new Panel(
            $('#panel'),
            255,
            20,
            10
        );
    });

    </script>
    <style type="text/css">
    body {
        margin: 2em;
    }
    #panel select {
        margin-bottom: 10px;
        width: 100%;
    }
    #panel {
        float: left;
        padding: 10px;
        border: 1px dotted gray;
    }
    </style>
</head>
<body>
    <div id="panel"></div>
</body>
</html>
