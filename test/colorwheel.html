<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="../jquery-1.8.1.js" type="text/javascript"></script>
    <script src="../color-picker.js" type="text/javascript"></script>
    <script type="text/javascript">
(function (window) {
    "use strict";
    window.TESTSUITE(window);
    var self = {
        diameter: 400,
        widthRatio: 0.1
    };

    $(function () {

        var canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 400;
        canvas.style.display = 'block';
        self.canvases = [$(canvas).clone().appendTo('body')[0]];
        var startTime = new Date();
        test1(self);
        var duration = new Date() - startTime;
        $('body').append(duration+" mS<br/>")
        self.canvases = [$(canvas).clone().appendTo('body')[0]];
        startTime = new Date();
        test2(self);
        duration = new Date() - startTime;
        $('body').append(duration+" mS<br/>")
        self.canvases = [$(canvas).clone().appendTo('body')[0]];
        startTime = new Date();
        test3(self);
        duration = new Date() - startTime;
        $('body').append(duration+" mS<br/>")
    });

    var Cache = {
        ColorWheelBg: 0
    };
    function ColorPicker_drawColorWheelBg(retval, diameter) {
        var retvalCtx = retval.getContext("2d");
        var temp = $("<canvas>")
            .attr("width", diameter)
            .attr("height", diameter)[0];
        var tempCtx = temp.getContext("2d");
        if (! Cache.ColorWheelBg) {
            Cache.ColorWheelBg = retvalCtx.createImageData(80, 80);
            var degree, i, j, x, y, r, g, b, rad2deg = (180/Math.PI);
            var getValue = function (degree) {
                degree %= 360;
                if (degree >= 240) {
                    return 0;
                } else if (degree >= 180) {
                    return 255 * ((240 - degree) / 60);
                } else if (degree >= 60) {
                    return 255;
                }
                return 255 * (degree / 60);
            };
            for (i = 0; i < 80; i++) {
                x = i - 40;
                for (j = 0; j < 80; j++) {
                    y = j - 40;
                    degree = Math.atan2(x, y) * rad2deg + 270;
                    r = getValue(degree + 120);
                    g = getValue(degree);
                    b = getValue(degree + 240);
                    setPixel(Cache.ColorWheelBg, i, j, [r, g, b, 255]);
                }
            }
        }
        retvalCtx.putImageData(Cache.ColorWheelBg, 0, 0);
        tempCtx.scale(diameter/80, diameter/80);
        tempCtx.drawImage(retval, 0, 0);
        retvalCtx.drawImage(temp, 0, 0);
    }
    function test1(self) {
        var diameter = self.diameter;
        var ctx = self.canvases[0].getContext("2d");
        ColorPicker_drawColorWheelBg(self.canvases[0], diameter);
    }

    function test2(self) {
        var diameter = self.diameter;
        var ctx = self.canvases[0].getContext("2d");
        ColorPicker_drawColorWheelBg(self.canvases[0], diameter);

        var lineWidth = self.widthRatio * diameter;
        var circleRadius = (diameter / 2) - 5 - lineWidth / 2;
        var origin = [diameter / 2, diameter / 2];

        // cut out doughnut
        /** webkit bug prevents usage of "destination-in" **/
        ctx.globalCompositeOperation = "destination-out";
        ctx.strokeStyle = "rgba(0,0,0,1)";
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        ctx.arc(origin[0], origin[1], circleRadius - (self.widthRatio * diameter / 2), 0, Math.PI*2);
        ctx.closePath();
        ctx.fill();
        ctx.globalCompositeOperation = "source-over";
    }

    function test3(self) {
        var diameter = self.diameter;
        var ctx = self.canvases[0].getContext("2d");
        ColorPicker_drawColorWheelBg(self.canvases[0], diameter);

        var lineWidth = self.widthRatio * diameter;
        var circleRadius = (diameter / 2) - 5 - lineWidth / 2;
        var origin = [diameter / 2, diameter / 2];

        // cut out doughnut
        /** webkit bug prevents usage of "destination-in" **/
        ctx.globalCompositeOperation = "destination-out";
        ctx.strokeStyle = "rgba(0,0,0,1)";
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        ctx.arc(origin[0], origin[1], circleRadius - (self.widthRatio * diameter / 2), 0, Math.PI*2);
        ctx.closePath();
        ctx.fill();
        ctx.lineWidth = circleRadius * 2 - (self.widthRatio * diameter / 2);
        ctx.beginPath();
        ctx.arc(origin[0], origin[1], circleRadius * 2, 0, Math.PI*2);
        ctx.closePath();
        ctx.stroke();
    }
})(window);
    </script>
    <style type="text/css">
        body {
            margin: 2em;
            background: #adf;
        }
    </style>
</head>
<body>

</body>
</html>
